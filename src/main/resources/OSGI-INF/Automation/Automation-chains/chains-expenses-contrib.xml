<?xml version="1.0" encoding="UTF-8"?>

<component name="org.athento.nuxeo.athento-nx-administrative-doctypes.chains-expenses"
    version="1.0.0">
    <require>org.nuxeo.runtime.started</require>

    <extension target="org.nuxeo.ecm.core.operation.OperationServiceComponent"
        point="chains">

        <chain id="Expenses-assignID-approved">
            <documentation>
                Assign ID with the following rules: NG-AAMM-0000000-XX Checks in the Document for versioning
                With:   NG as constant string
                AA year
                MM month
                0000000 unique ID for each year
                XX unique ID sufix
            </documentation>
            <operation id="Context.FetchDocument" />
            <!-- Year YYYY. Used for uniqueness of number id -->
            <operation id="Context.SetVar">
                <param type="string" name="name">complete_year_var</param>
                <param type="object" name="value">expr:new
                    java.text.SimpleDateFormat("yyyy").format(Document["dc:created"].getTime())
                </param>
            </operation>
            <!-- Year. Used for uniqueness of number id AND the composition of the id -->
            <operation id="Context.SetVar">
                <param type="string" name="name">year_var</param>
                <param type="object" name="value">expr:new
                    java.text.SimpleDateFormat("yy").format(Document["dc:created"].getTime())
                </param>
            </operation>
            <!-- Month. Used for uniqueness of number id AND the composition of the id -->
            <operation id="Context.SetVar">
                <param type="string" name="name">month_var</param>
                <param type="object" name="value">expr:new
                    java.text.SimpleDateFormat("MM").format(Document["dc:created"].getTime())
                </param>
            </operation>
            <!-- NG unique ID for each year -->
            <operation id="Context.SetVar">
                <param type="string" name="name">idNumber_var</param>
                <param type="object" name="value">expr:Fn.getNextId("unique-ex-year-key"+complete_year_var)
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">idNumber_var</param>
                <param type="object" name="value">expr:idNumber_var.format("%07d",Integer.valueOf(idNumber_var))
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">company_var</param>
                <param type="object" name="value">expr:Document["userFile:office"].charAt(0) == '0' ? '01' :
                    Document["userFile:office"].charAt(0) == '1' ? '01' :
                    Document["userFile:office"].charAt(0) == '2' ? '01' :
                    Document["userFile:office"].charAt(0) == '5' ? '50' :
                    '70'
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">id_var</param>
                <param type="object" name="value">expr:@{"NG-"+company_var+"-"+year_var+month_var+"-"+idNumber_var}
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">dc:title</param>
                <param type="boolean" name="save">true</param>
                <param type="serializable" name="value">expr:id_var
                </param>
            </operation>

        </chain>

        <chain id="Expenses-assignID">
            <documentation>
                Assign ID with the following rules: NG-AAMM-0000000-XX Checks in the Document for versioning
                With:   NG as constant string
                AA year
                MM month
                0000000 unique ID for each year
                XX unique ID sufix
            </documentation>
            <operation id="Context.FetchDocument" />
            <!-- Year YYYY. Used for uniqueness of number id -->
            <operation id="Context.SetVar">
                <param type="string" name="name">complete_year_var</param>
                <param type="object" name="value">expr:new
                    java.text.SimpleDateFormat("yyyy").format(Document["dc:created"].getTime())
                </param>
            </operation>
            <!-- Year. Used for uniqueness of number id AND the composition of the id -->
            <operation id="Context.SetVar">
                <param type="string" name="name">year_var</param>
                <param type="object" name="value">expr:new
                    java.text.SimpleDateFormat("yy").format(Document["dc:created"].getTime())
                </param>
            </operation>
            <!-- Month. Used for uniqueness of number id AND the composition of the id -->
            <operation id="Context.SetVar">
                <param type="string" name="name">month_var</param>
                <param type="object" name="value">expr:new
                    java.text.SimpleDateFormat("MM").format(Document["dc:created"].getTime())
                </param>
            </operation>
            <!-- NG unique ID for each year -->
            <operation id="Context.SetVar">
                <param type="string" name="name">idNumber_var</param>
                <param type="object" name="value">expr:Fn.getNextId("unique-ex-year-key"+complete_year_var)
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">idNumber_var</param>
                <param type="object" name="value">expr:idNumber_var.format("%07d",Integer.valueOf(idNumber_var))
                </param>
            </operation>
            <!-- NG-AAMM-0000000 full prefix -->
            <operation id="Context.SetVar">
                <param type="string" name="name">prefix_id_var</param>
                <param type="object" name="value">expr:@{"NG-"+year_var+month_var+"-"+idNumber_var}
                </param>
            </operation>
            <!-- Number, which is formatted with 2 digits -->
            <operation id="Context.SetVar">
                <param type="string" name="name">uniqueexnumber_var</param>
                <param type="object" name="value">expr:Fn.getNextId("unique-ex-key"+prefix_id_var)
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">uniqueexnumberformatted_var</param>
                <param type="object" name="value">expr:uniqueexnumber_var.format("%02d",Integer.valueOf(uniqueexnumber_var))
                </param>
            </operation>
            <!-- Final variable id_var with the ID composition. Stored in both title and projectid -->
            <operation id="Context.SetVar">
                <param type="string" name="name">id_var</param>
                <param type="object" name="value">expr:@{prefix_id_var + "-" + uniqueexnumberformatted_var}
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseYear</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:year_var
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseMonth</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:month_var
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">dc:title</param>
                <param type="boolean" name="save">true</param>
                <param type="serializable" name="value">expr:id_var
                </param>
            </operation>
            <operation id="Document.CheckIn">
                <param type="string" name="version">0.0</param>
            </operation>

        </chain>

        <chain id="Athento.expensesCalculations">
            <documentation>
                This chain runs the main operation. Try to keep this chain as simple as possible so we always
                have a simple high level chain.
            </documentation>

            <operation id="Context.FetchDocument" />

            <operation id="Context.RunOperation">
                <param type="string" name="id">Athento.expensesPerDay</param>
                <param type="boolean" name="isolate">false</param>
            </operation>

        </chain>

        <chain id="Athento.expensesPerDay">
            <documentation>
                Main Chain that distributes the logic of per day calculations by category.
                If we need a new category, or need to modify them, this is the Chain.

                For every category, if current category property is not empty, runs a subchain
                passing the "category" as parameter to sum every expense in that category.
                If not, zero totals are initialized for that category.

                Finally, after previous subchains, Total values have been calculated and in
                this last chain all of them sum for the current expenseTotal value, which is
                stored in the proper document property.
            </documentation>
            <operation id="Context.FetchDocument" />
            <operation id="Document.RemoveProperty">
                <param type="string" name="xpath">administrative:expensePerDay</param>
                <param type="boolean" name="save">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">Athento.InitializeZeroTotalsBySubcategory</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:Document["administrative:expenseTravel"] == empty ?
                    "Athento.InitializeZeroTotalsByCategory" :
                    "Athento.expensesPerDayByCategory"</param>
                <param type="properties" name="parameters">expenseCategory = Travel</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:Document["administrative:expenseNonTravel"] == empty ?
                    "Athento.InitializeZeroTotalsByCategory" :
                    "Athento.expensesPerDayByCategory"</param>
                <param type="properties" name="parameters">expenseCategory = NonTravel</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:Document["administrative:expenseKm"] == empty ?
                    "Athento.InitializeZeroTotalsByCategory" :
                    "Athento.expensesPerDayByCategory"</param>
                <param type="properties" name="parameters">expenseCategory = Km</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:Document["administrative:expenseCourse"] == empty ?
                    "Athento.InitializeZeroTotalsByCategory" :
                    "Athento.expensesPerDayByCategory"</param>
                <param type="properties" name="parameters">expenseCategory = Course</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseTotal</param>
                <param type="integer" name="value">expr:expenseTravelTotal+
                    expenseNonTravelTotal+expenseKmTotal+expenseCourseTotal
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:expenseTotal == empty ? empty : expenseTotal
                </param>
            </operation>
        </chain>

        <chain id="Athento.InitializeZeroTotalsByCategory">
            <documentation>
                Initialize 0 values in totals.
            </documentation>
            <param type="string" name="expenseCategory"/>
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseCategory</param>
                <param type="string" name="value">expr:@{ChainParameters['expenseCategory']}
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:"expense" + expenseCategory + "Total"</param>
                <param type="integer" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:"administrative:expense" + expenseCategory + "Total"</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:Context["expense" + expenseCategory + "Total"]
                </param>
            </operation>
        </chain>

        <chain id="Athento.InitializeZeroTotalsBySubcategory">
            <documentation>
                TODO: Make this chain GENERIC

                Initializes to Zero the partial sums of every category. Totally specific, needs to be reimplemented to
                make it generic.

                expenseRestaurantTravelTotal
                expenseCustomerTravelTotal
                expenseOthersTravelTotal
                expenseTransportTravelTotal
                expenseJourneyTravelTotal
                expenseLodgingTravelTotal

                expenseRestaurantNonTravelTotal
                expenseCustomerNonTravelTotal
                expenseOthersNonTravelTotal
                expenseTransportNonTravelTotal
                expenseJourneyNonTravelTotal
                expenseLodgingNonTravelTotal

                expenseCompanyKmTotal
                expenseOwnKmTotal

            </documentation>
            <operation id="Context.FetchDocument" />

            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseKmTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseCourseTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>

            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseRestaurantTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseCustomerTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseOthersTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseTransportTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseJourneyTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseLodgingTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseRestaurantNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseCustomerNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseOthersNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseTransportNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseJourneyNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseLodgingNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseCompanyKmTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseOwnKmTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDayByCategory">
            <documentation>
                Generic operation that sums expenses by day.
            </documentation>
            <param type="string" name="expenseCategory"/>
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseCategory</param>
                <param type="string" name="value">expr:@{ChainParameters['expenseCategory']}
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:"expense" + expenseCategory + "Total"</param>
                <param type="integer" name="value">0
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:"expense" + expenseCategory</param>
                <param type="integer" name="value">0
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayIndExpenseCategory</param>
                <param type="integer" name="value">0</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDate</param>
                <param type="object" name="value">expr:Document["administrative:expense" + expenseCategory + "/[" + expensePerDayIndExpenseCategory + "]/expenseDate"]
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseDate == empty ? "voidChain" :
                    "Athento.expensesPerDayIterate"</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:"administrative:expense" + expenseCategory + "Total"</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:Context["expense" + expenseCategory + "Total"]
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDayIterate">
            <documentation>
                Generic operation that sums expenses by day in an iterative way.
            </documentation>
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expense</param>
                <param type="integer" name="value">expr:Document["administrative:expense" + expenseCategory + "/[" + expensePerDayIndExpenseCategory + "]/expense"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">category</param>
                <param type="integer" name="value">expr:Document["administrative:expense" + expenseCategory + "/[" + expensePerDayIndExpenseCategory + "]/category"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayInd</param>
                <param type="integer" name="value">0
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:@{"expense" + expenseCategory}</param>
                <param type="integer" name="value">0
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayHit</param>
                <param type="boolean" name="value">false
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:category == empty ? "voidChain" :
                    "Athento.expensesPreformatExpense"
                </param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseDate == empty ? "voidChain" :
                    "Athento.expensesPerDaySumDayByDay"
                </param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseToSum</param>
                <param type="integer" name="value">expr:Context["expense" + expenseCategory + "Total"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:"expense" + expenseCategory + "Total"</param>
                <param type="integer" name="value">expr:expenseToSum + expense
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayIndExpenseCategory</param>
                <param type="integer" name="value">expr:expensePerDayIndExpenseCategory+1
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDate</param>
                <param type="object" name="value">expr:Document["administrative:expense" + expenseCategory + "/[" + expensePerDayIndExpenseCategory + "]/expenseDate"]
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseDate == empty ? "voidchain" :
                    "Athento.expensesPerDayIterate"</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
        </chain>

        <chain id="Athento.expensesPreformatExpense">
            <documentation>
                Specific precalculations based on the specific category of the expense.
            </documentation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseSubcategoryInd</param>
                <param type="string" name="value">expr:category.substring(0,2)
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseSubcategoryInd == '80' ? "Athento.expensesKm" :
                    expenseSubcategoryInd == '90' ? "Athento.expensesKm" : 'voidChain'</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDaySumDayByDay">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDatePerDay</param>
                <param type="object" name="value">expr:Document["administrative:expensePerDay/["+expensePerDayInd+"]/expenseDate"]
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseDatePerDay == empty ? "Athento.expensesPerDayAddNewDay" :
                    "Athento.expensesPerDaySumDayByDayIterate"</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDaySumDayByDayIterate">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDateForm</param>
                <param type="integer" name="value">expr:new java.text.SimpleDateFormat("yyyy-MM-dd")
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDatePerDayFormatted</param>
                <param type="integer" name="value">expr:expenseDateForm.format(expenseDatePerDay.getTime())
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDateFormatted</param>
                <param type="integer" name="value">expr:expenseDateForm.format(expenseDate.getTime())
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayHit</param>
                <param type="boolean" name="value">expr:expenseDatePerDayFormatted == expenseDateFormatted
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expensePerDayHit ? "Athento.expensesPerDaySum" :
                    "voidChain"</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayInd</param>
                <param type="integer" name="value">expr:expensePerDayInd+1
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDatePerDay</param>
                <param type="object" name="value">expr:Document["administrative:expensePerDay/[" + expensePerDayInd + "]/expenseDate"]
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expensePerDayHit ? 'voidChain' : expenseDatePerDay == empty ? "Athento.expensesPerDayAddNewDay" :
                    "Athento.expensesPerDaySumDayByDayIterate"</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayHit</param>
                <param type="boolean" name="value">false
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDaySum">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDay</param>
                <param type="integer" name="value">expr:Document["administrative:expensePerDay/["+expensePerDayInd+"]/expense"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDay</param>
                <param type="integer" name="value">expr:expensePerDay+expense
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:category == empty ? 'voidChain' : 'Athento.expensesPerDaySumCategorized'</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expensePerDay/["+expensePerDayInd+"]/expense"}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:expensePerDay
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDayAddNewDay">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDateForm</param>
                <param type="integer" name="value">expr:new java.text.SimpleDateFormat("yyyy-MM-dd")
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDateFormatted</param>
                <param type="integer" name="value">expr:expenseDateForm.format(expenseDate.getTime())
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDay</param>
                <param type="integer" name="value">expr:expense
                </param>
            </operation>
            <operation id="Athento.SetComplexProperty">
                <param type="string" name="xpath">administrative:expensePerDay</param>
                <param type="boolean" name="save">false</param>
                <param type="properties" name="properties">expr:expenseDate=@{expenseDateFormatted}
                    expense=@{expense}
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:category == empty ? 'voidChain' : 'Athento.expensesPerDaySumCategorized'</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDaySumCategorized">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseSubcategoryInd</param>
                <param type="string" name="value">expr:category.substring(0,2)
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseSubcategoryAssociated</param>
                <param type="string" name="value">expr:expenseSubcategoryInd == '00' ? 'Restaurant' :
                    expenseSubcategoryInd == '10' ? 'Customer' :
                    expenseSubcategoryInd == '20' ? 'Others' :
                    expenseSubcategoryInd == '30' ? 'Transport' :
                    expenseSubcategoryInd == '40' ? 'Journey' :
                    expenseSubcategoryInd == '50' ? 'Lodging' :
                    expenseSubcategoryInd == '80' ? 'Company' :
                    expenseSubcategoryInd == '90' ? 'Own' :
                    '0000'
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseSubcategoryAssociated == '0000' ? 'voidChain' :
                    'Athento.expensesPerDaySumCategorizedItem'</param>
                <param type="properties" name="parameters">expr:expenseSubcategoryInd = @{expenseSubcategoryInd}
                    expenseSubcategory = @{expenseSubcategoryAssociated}</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">logTesting</param>
                <param type="string" name="value">logTesting
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:@{"expense" + expenseCategory}</param>
                <param type="integer" name="value">expr:Context["expense" + expenseCategory] + expense
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expensePerDay/["+expensePerDayInd+"]/expense" + expenseCategory}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:Context["expense" + expenseCategory]
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDaySumCategorizedItem">
            <param type="string" name="expenseSubcategory"/>
            <param type="string" name="expenseSubcategoryInd"/>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseSubcategory</param>
                <param type="string" name="value">expr:@{ChainParameters['expenseSubcategory']}
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseSubcategoryInd</param>
                <param type="string" name="value">expr:@{ChainParameters['expenseSubcategoryInd']}
                </param>
            </operation>
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">@{"expense" + expenseSubcategory + expenseCategory}</param>
                <param type="integer" name="value">expr:expenseSubcategory == 'expenseSubcategoryInd'  ?
                    Context["expense" + expenseSubcategory + expenseCategory] + expense :
                    Context["expense" + expenseSubcategory + expenseCategory]
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expensePerDay/["+expensePerDayInd+"]/expense" + expenseSubcategory + expenseCategory}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:expensePerDay
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expense" + expenseSubcategory + expenseCategory+"Total"}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:Document["administrative:expense" + expenseSubcategory + expenseCategory+"Total"] + expense
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesKm">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">carkmcost</param>
                <param type="object" name="value">expr:new java.lang.Double(Fn.getVocabularyLabel("carkmcost", category))
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">goback</param>
                <param type="object" name="value">expr:new java.lang.Double(Document["administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/goback"])
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">route</param>
                <param type="integer" name="value">expr:Document["administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/route"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">routescom</param>
                <param type="object" name="value">expr:route == empty ?
                    Document["administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/km"] :
                    new java.lang.Double(Fn.getVocabularyLabel("routescom", route))
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expense</param>
                <param type="object" name="value">expr:routescom*goback*carkmcost
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:"expenseOwn" + expenseCategory + "Total"</param>
                <param type="integer" name="value">expr:Context["expenseOwn" + expenseCategory + "Total"] + expense
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/carOwner"}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:category == '9001' ? '901' : '801'
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/km"}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:routescom
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/expense"}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:expense
                </param>
            </operation>

        </chain>

        <chain id="Template-Liquidacion-de-gastos-before-save">
            <operation id="Context.FetchDocument"/>
            <operation id="Context.SetInputAsVar">
                <param type="string" name="name">documents</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">clase</param>
                <param type="object" name="value">expr:@{documents.getClass()}</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">essimple</param>
                <param type="boolean" name="value">expr:clase == 'class org.nuxeo.ecm.core.api.impl.DocumentModelImpl'</param>
            </operation>
            <operation id="Document.Fetch">
                <param type="document" name="value">expr:essimple ? documents : documents[0]</param>
            </operation>
            <operation id="TemplateProcessor.Render">
                <param type="string" name="templateName">Plantilla Gastos</param>
            </operation>
            <operation id="Blob.AttachOnDocument">
                <param type="document" name="document">expr:essimple ? documents : documents[0]</param>
                <param type="boolean" name="save">false</param>
                <param type="string" name="xpath">file:content</param>
            </operation>

        </chain>

        <chain id="Expenses-userInfo">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">office</param>
                <param type="object" name="value">expr:Document["userFile:office"]
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">userFile:account</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:office == empty ? empty : office
                </param>
            </operation>
        </chain>


    </extension>

</component>