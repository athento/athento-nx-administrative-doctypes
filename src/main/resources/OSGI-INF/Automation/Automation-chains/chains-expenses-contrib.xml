<?xml version="1.0" encoding="UTF-8"?>

<component name="org.athento.nuxeo.athento-nx-administrative-doctypes.chains-expenses"
    version="1.0.0">
    <require>org.nuxeo.runtime.started</require>

    <extension target="org.nuxeo.ecm.core.operation.OperationServiceComponent"
        point="chains">

        <chain id="Athento.expensesCalculations">
            <documentation>
                This chain runs the main operation. Try to keep this chain as simple as possible so we always
                have a simple high level chain.
            </documentation>

            <operation id="Context.FetchDocument" />

            <operation id="Context.RunOperation">
                <param type="string" name="id">Athento.expensesPerDay</param>
                <param type="boolean" name="isolate">false</param>
            </operation>

        </chain>

        <chain id="Athento.expensesPerDay">
            <documentation>
                Main Chain that distributes the logic of per day calculations by category.
                If we need a new category, or need to modify them, this is the Chain.

                For every category, if current category property is not empty, runs a subchain
                passing the "category" as parameter to sum every expense in that category.
                If not, zero totals are initialized for that category.

                Finally, after previous subchains, Total values have been calculated and in
                this last chain all of them sum for the current expenseTotal value, which is
                stored in the proper document property.
            </documentation>
            <operation id="Context.FetchDocument" />
            <operation id="Document.RemoveProperty">
                <param type="string" name="xpath">administrative:expensePerDay</param>
                <param type="boolean" name="save">false</param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:message</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:empty
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:needsmanagingapproval</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">false
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:needsmaximization</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">false
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:specialAuthorization</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">false
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">Athento.InitializeZeroTotalsBySubcategory</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:Document["administrative:expenseTravel"] == empty ?
                    "Athento.InitializeZeroTotalsByCategory" :
                    "Athento.expensesPerDayByCategory"</param>
                <param type="properties" name="parameters">expenseCategory = Travel</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:Document["administrative:expenseNonTravel"] == empty ?
                    "Athento.InitializeZeroTotalsByCategory" :
                    "Athento.expensesPerDayByCategory"</param>
                <param type="properties" name="parameters">expenseCategory = NonTravel</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:Document["administrative:expenseKm"] == empty ?
                    "Athento.InitializeZeroTotalsByCategory" :
                    "Athento.expensesPerDayByCategory"</param>
                <param type="properties" name="parameters">expenseCategory = Km</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:Document["administrative:expenseKmOffices"] == empty ?
                    "Athento.InitializeZeroTotalsByCategory" :
                    "Athento.expensesPerDayByCategory"</param>
                <param type="properties" name="parameters">expenseCategory = KmOffices</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:Document["administrative:expenseCourse"] == empty ?
                    "Athento.InitializeZeroTotalsByCategory" :
                    "Athento.expensesPerDayByCategory"</param>
                <param type="properties" name="parameters">expenseCategory = Course</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseTotal</param>
                <param type="integer" name="value">expr:expenseTravelTotal+
                    expenseNonTravelTotal+expenseKmTotal+expenseKmOfficesTotal+expenseCourseTotal
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">Athento.ExpensesOutputFormat</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:expenseTotal == empty ? empty : expenseTotal
                </param>
            </operation>
        </chain>

        <chain id="Athento.InitializeZeroTotalsByCategory">
            <documentation>
                Initialize 0 values in totals.
            </documentation>
            <param type="string" name="expenseCategory"/>
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseCategory</param>
                <param type="string" name="value">expr:@{ChainParameters['expenseCategory']}
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:"expense" + expenseCategory + "Total"</param>
                <param type="integer" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:"administrative:expense" + expenseCategory + "Total"</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:Context["expense" + expenseCategory + "Total"]
                </param>
            </operation>
        </chain>

        <chain id="Athento.InitializeZeroTotalsBySubcategory">
            <documentation>
                TODO: Make this chain GENERIC

                Initializes to Zero the partial sums of every category. Totally specific, needs to be reimplemented to
                make it generic.

                expenseRestaurantTravelTotal
                expenseCustomerTravelTotal
                expenseOthersTravelTotal
                expenseTransportTravelTotal
                expenseDietsTravelTotal
                expenseLodgingTravelTotal

                expenseRestaurantNonTravelTotal
                expenseCustomerNonTravelTotal
                expenseOthersNonTravelTotal
                expenseTransportNonTravelTotal
                expenseDietsNonTravelTotal
                expenseLodgingNonTravelTotal

                expenseCompanyKmTotal
                expenseOwnKmTotal

                expenseCompanyKmOfficesTotal
                expenseOwnKmOfficesTotal

                expenseCourseTotal

            </documentation>
            <operation id="Context.FetchDocument" />

            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseKmTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseCourseTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>

            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseRestaurantTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseCustomerTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseOthersTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseTransportTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseDietsTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseLodgingTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseRestaurantNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseCustomerNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseOthersNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseTransportNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseDietsNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseLodgingNonTravelTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseCompanyKmTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseOwnKmTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseCompanyKmOfficesTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseOwnKmOfficesTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseCourseTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">0
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDayByCategory">
            <documentation>
                Generic operation that sums expenses by day.
            </documentation>
            <param type="string" name="expenseCategory"/>
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseCategory</param>
                <param type="string" name="value">expr:@{ChainParameters['expenseCategory']}
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:"expense" + expenseCategory + "Total"</param>
                <param type="integer" name="value">0
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:"expense" + expenseCategory</param>
                <param type="integer" name="value">0
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayIndExpenseCategory</param>
                <param type="integer" name="value">0</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDate</param>
                <param type="object" name="value">expr:Document["administrative:expense" + expenseCategory + "/[" + expensePerDayIndExpenseCategory + "]/expenseDate"]
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseDate == empty ? "voidChain" :
                    "Athento.expensesPerDayIterate"</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:"administrative:expense" + expenseCategory + "Total"</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:Context["expense" + expenseCategory + "Total"]
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDayIterate">
            <documentation>
                Generic operation that sums expenses by day in an iterative way.
            </documentation>
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expense</param>
                <param type="integer" name="value">expr:Document["administrative:expense" + expenseCategory + "/[" + expensePerDayIndExpenseCategory + "]/expense"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">category</param>
                <param type="integer" name="value">expr:Document["administrative:expense" + expenseCategory + "/[" + expensePerDayIndExpenseCategory + "]/category"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayInd</param>
                <param type="integer" name="value">0
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:@{"expense" + expenseCategory}</param>
                <param type="integer" name="value">0
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayHit</param>
                <param type="boolean" name="value">false
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">Athento.expensesPreformatExpense
                </param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseDate == empty ? "voidChain" :
                    "Athento.expensesPerDaySumDayByDay"
                </param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseToSum</param>
                <param type="integer" name="value">expr:Context["expense" + expenseCategory + "Total"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:"expense" + expenseCategory + "Total"</param>
                <param type="integer" name="value">expr:expenseToSum + expense
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayIndExpenseCategory</param>
                <param type="integer" name="value">expr:expensePerDayIndExpenseCategory+1
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDate</param>
                <param type="object" name="value">expr:Document["administrative:expense" + expenseCategory + "/[" + expensePerDayIndExpenseCategory + "]/expenseDate"]
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseDate == empty ? "voidchain" :
                    "Athento.expensesPerDayIterate"</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
        </chain>

        <chain id="Athento.expensesPreformatExpense">
            <documentation>
                Specific precalculations based on the specific category of the expense or any exception.
            </documentation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseSubcategoryInd</param>
                <param type="string" name="value">expr:category.substring(0,2)
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseSubcategoryInd == '80' ? "Athento.expensesKm" :
                    expenseSubcategoryInd == '90' ? "Athento.expensesKm" :
                    expenseSubcategoryInd == '70' ? "Athento.expensesCourses" :
                    'voidChain'</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDaySumDayByDay">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDatePerDay</param>
                <param type="object" name="value">expr:Document["administrative:expensePerDay/["+expensePerDayInd+"]/expenseDate"]
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseDatePerDay == empty ? "Athento.expensesPerDayAddNewDay" :
                    "Athento.expensesPerDaySumDayByDayIterate"</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDaySumDayByDayIterate">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDateForm</param>
                <param type="integer" name="value">expr:new java.text.SimpleDateFormat("yyyy-MM-dd")
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDatePerDayFormatted</param>
                <param type="integer" name="value">expr:expenseDateForm.format(expenseDatePerDay.getTime())
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDateFormatted</param>
                <param type="integer" name="value">expr:expenseDateForm.format(expenseDate.getTime())
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayHit</param>
                <param type="boolean" name="value">expr:expenseDatePerDayFormatted == expenseDateFormatted
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expensePerDayHit ? "Athento.expensesPerDaySum" :
                    "voidChain"</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayInd</param>
                <param type="integer" name="value">expr:expensePerDayInd+1
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDatePerDay</param>
                <param type="object" name="value">expr:Document["administrative:expensePerDay/[" + expensePerDayInd + "]/expenseDate"]
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expensePerDayHit ? 'voidChain' : expenseDatePerDay == empty ? "Athento.expensesPerDayAddNewDay" :
                    "Athento.expensesPerDaySumDayByDayIterate"</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayHit</param>
                <param type="boolean" name="value">false
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDaySum">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDay</param>
                <param type="integer" name="value">expr:Document["administrative:expensePerDay/["+expensePerDayInd+"]/expense"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDay</param>
                <param type="integer" name="value">expr:expensePerDay+expense
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expensePerDay/["+expensePerDayInd+"]/expense"}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:expensePerDay
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">Athento.expensesPerDaySumCategorized</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDayAddNewDay">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDateForm</param>
                <param type="integer" name="value">expr:new java.text.SimpleDateFormat("yyyy-MM-dd")
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseDateFormatted</param>
                <param type="integer" name="value">expr:expenseDateForm.format(expenseDate.getTime())
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDay</param>
                <param type="integer" name="value">expr:expense
                </param>
            </operation>
            <operation id="Athento.SetComplexProperty">
                <param type="string" name="xpath">administrative:expensePerDay</param>
                <param type="boolean" name="save">false</param>
                <param type="properties" name="properties">expr:expenseDate=@{expenseDateFormatted}
                    expense=@{expense}
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:category == empty ? 'voidChain' : 'Athento.expensesPerDaySumCategorized'</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDaySumCategorized">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseSubcategoryInd</param>
                <param type="string" name="value">expr:category.substring(0,2)
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseSubcategoryAssociated</param>
                <param type="string" name="value">expr:expenseSubcategoryInd == '00' ? 'Restaurant' :
                    expenseSubcategoryInd == '10' ? 'Customer' :
                    expenseSubcategoryInd == '20' ? 'Others' :
                    expenseSubcategoryInd == '30' ? 'Transport' :
                    expenseSubcategoryInd == '40' ? 'Diets' :
                    expenseSubcategoryInd == '50' ? 'Lodging' :
                    expenseSubcategoryInd == '80' ? 'Company' :
                    expenseSubcategoryInd == '90' ? 'Own' :
                    '0000'
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseSubcategoryAssociated == '0000' ? 'voidChain' :
                    'Athento.expensesPerDaySumCategorizedItem'</param>
                <param type="properties" name="parameters">expr:expenseSubcategoryInd = @{expenseSubcategoryInd}
                    expenseSubcategory = @{expenseSubcategoryAssociated}</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expensePerDayCategorized</param>
                <param type="integer" name="value">expr:Document["administrative:expensePerDay/["+expensePerDayInd+"]/expense" + expenseCategory] == empty ?
                    0 : Document["administrative:expensePerDay/["+expensePerDayInd+"]/expense" + expenseCategory]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:@{"expense" + expenseCategory}</param>
                <param type="integer" name="value">expr:expensePerDayCategorized + expense
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expensePerDay/["+expensePerDayInd+"]/expense" + expenseCategory}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:Context["expense" + expenseCategory]
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesPerDaySumCategorizedItem">
            <param type="string" name="expenseSubcategory"/>
            <param type="string" name="expenseSubcategoryInd"/>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseSubcategory</param>
                <param type="string" name="value">expr:@{ChainParameters['expenseSubcategory']}
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseSubcategoryInd</param>
                <param type="string" name="value">expr:@{ChainParameters['expenseSubcategoryInd']}
                </param>
            </operation>
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:@{"expense" + expenseSubcategory + expenseCategory}</param>
                <param type="integer" name="value">expr:Document["administrative:expensePerDay/["+expensePerDayInd+"]/expense" + expenseSubcategory + expenseCategory] == empty  ?
                    0 : Document["administrative:expensePerDay/["+expensePerDayInd+"]/expense" + expenseSubcategory + expenseCategory]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expr:@{"expense" + expenseSubcategory + expenseCategory}</param>
                <param type="integer" name="value">expr:Context["expense" + expenseSubcategory + expenseCategory] + expense
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expensePerDay/["+expensePerDayInd+"]/expense" + expenseSubcategory + expenseCategory}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:Context["expense" + expenseSubcategory + expenseCategory]
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expense" + expenseSubcategory + expenseCategory+"Total"}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:Document["administrative:expense" + expenseSubcategory + expenseCategory+"Total"] + expense
                </param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">Athento.expensesChecksEscalation</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">Athento.expensesChecksMaximization</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
        </chain>

        <chain id="Athento.expensesKm">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">carkmcost</param>
                <param type="object" name="value">expr:new java.lang.Double(Fn.getVocabularyLabel("carkmcost", category))
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">goback</param>
                <param type="object" name="value">expr:new java.lang.Double(Document["administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/goback"])
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">route</param>
                <param type="integer" name="value">expr:Document["administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/route"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">routescom</param>
                <param type="object" name="value">expr:Document["administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/km"] == empty ?
                    new java.lang.Double(Fn.getVocabularyLabel("routescom", route)) :
                    Document["administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/km"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expense</param>
                <param type="object" name="value">expr:routescom*goback*carkmcost
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/carOwner"}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:category == '9001' ? '901' : '801'
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/km"}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:routescom
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/expense"}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:expense
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesCourses">
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expense</param>
                <param type="object" name="value">expr:new java.lang.Double(Fn.getVocabularyLabel("courseexp", category))
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">expr:@{"administrative:expense" + expenseCategory + "/["+expensePerDayIndExpenseCategory+"]/expense"}</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:expense
                </param>
            </operation>
        </chain>

        <chain id="Athento.ExpensesOutputFormat">
            <documentation>
                Exceptions in the stablished final category and subcategory format.
                TODO: Generalize this
            </documentation>
            <operation id="Context.FetchDocument" />
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseOwnKmTotal</param>
                <param type="object" name="value">expr:Document["administrative:administrative:expenseOwnKmTotal"] == empty ?
                    0 : Document["administrative:administrative:expenseOwnKmTotal"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseCompanyKmTotal</param>
                <param type="object" name="value">expr:Document["administrative:administrative:expenseCompanyKmTotal"] == empty ?
                    0 : Document["administrative:administrative:expenseCompanyKmTotal"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseOwnKmOfficesTotal</param>
                <param type="object" name="value">expr:Document["administrative:administrative:expenseOwnKmOfficesTotal"] == empty ?
                    0 : Document["administrative:administrative:expenseOwnKmOfficesTotal"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseCompanyKmOfficesTotal</param>
                <param type="object" name="value">expr:Document["administrative:administrative:expenseCompanyKmOfficesTotal"] == empty ?
                    0 : Document["administrative:administrative:expenseCompanyKmOfficesTotal"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseKmOfficesTotal</param>
                <param type="object" name="value">expr:Document["administrative:administrative:expenseKmOfficesTotal"] == empty ?
                    0 : Document["administrative:administrative:expenseKmOfficesTotal"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseKmTotal</param>
                <param type="object" name="value">expr:Document["administrative:administrative:expenseKmTotal"] == empty ?
                    0 : Document["administrative:administrative:expenseKmTotal"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseKmTotal</param>
                <param type="object" name="value">expr:expenseKmTotal + expenseKmOfficesTotal
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseOwnKmTotal</param>
                <param type="object" name="value">expr:expenseOwnKmTotal + expenseOwnKmOfficesTotal
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">expenseCompanyKmTotal</param>
                <param type="object" name="value">expr:expenseCompanyKmTotal + expenseCompanyKmOfficesTotal
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseKmTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:expenseKmTotal == 0 ? empty : expenseKmTotal
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseOwnKmTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:expenseOwnKmTotal == 0 ? empty : expenseOwnKmTotal
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:expenseCompanyKmTotal</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:expenseCompanyKmTotal == 0 ? empty : expenseCompanyKmTotal
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesChecksEscalation">
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseCategory != 'NonTravel' ? 'voidChain' :
                    expenseSubcategory != 'Restaurant' ? 'voidChain' :
                    Document["administrative:needsmanagingapproval"] == true ? 'voidChain' :
                    'Athento.expensesNeedsEscalation'</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseCategory != 'NonTravel' ? 'voidChain' :
                    expenseSubcategory != 'Customer' ? 'voidChain' :
                    Document["administrative:needsmanagingapproval"] == true ? 'voidChain' :
                    'Athento.expensesNeedsEscalation'</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
        </chain>

        <chain id="Athento.expensesChecksMaximization">
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseCategory != 'Travel' ? 'voidChain' :
                    expenseSubcategory != 'Restaurant' ? 'voidChain' :
                    Document["administrative:needsmaximization"] == true ? 'voidChain' :
                    'Athento.expensesNeedsMaximization'</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseCategory != 'Travel' ? 'voidChain' :
                    expenseSubcategory != 'Customer' ? 'voidChain' :
                    Document["administrative:needsmaximization"] == true ? 'voidChain' :
                    'Athento.expensesNeedsMaximization'</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
            <operation id="Context.RunOperation">
                <param type="string" name="id">expr:expenseCategory != 'Travel' ? 'voidChain' :
                    expenseSubcategory != 'Diets' ? 'voidChain' :
                    Document["administrative:needsmaximization"] == true ? 'voidChain' :
                    'Athento.expensesNeedsMaximization'</param>
                <param type="boolean" name="isolate">false</param>
            </operation>
        </chain>

        <chain id="Athento.expensesNeedsEscalation">
            <operation id="Context.SetVar">
                <param type="string" name="name">threshold</param>
                <param type="integer" name="value">28
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">curval</param>
                <param type="integer" name="value">expr:Context["expense" + expenseSubcategory + expenseCategory]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">inviteds</param>
                <param type="integer" name="value">expr:Document["administrative:expense" + expenseCategory + "/[" + expensePerDayIndExpenseCategory + "]/invitedNumber"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">evaluation</param>
                <param type="boolean" name="value">expr:(curval / inviteds) > threshold ?
                    true : false
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:needsmanagingapproval</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:evaluation
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:message</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:evaluation ? Document["administrative:message"] + "Al menos un día supera el gasto máximo diario por comensal permitido. Por favor, revise la solicitud, o seleccione que efectivamente es correcto y solicita aprobación de Dirección General. \n" :
                    Document["administrative:message"]
                </param>
            </operation>
        </chain>

        <chain id="Athento.expensesNeedsMaximization">
            <operation id="Context.SetVar">
                <param type="string" name="name">threshold</param>
                <param type="integer" name="value">28
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">restaurant</param>
                <param type="integer" name="value">expr:Document["administrative:expensePerDay/[" + expensePerDayInd + "]/expenseRestaurantTravel"] == empty ?
                    0 : Document["administrative:expensePerDay/[" + expensePerDayInd + "]/expenseRestaurantTravel"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">customer</param>
                <param type="integer" name="value">expr:Document["administrative:expensePerDay/[" + expensePerDayInd + "]/expenseCustomerTravel"] == empty ?
                    0 : Document["administrative:expensePerDay/[" + expensePerDayInd + "]/expenseCustomerTravel"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">diets</param>
                <param type="integer" name="value">expr:Document["administrative:expensePerDay/[" + expensePerDayInd + "]/expenseDietsTravel"] == empty ?
                    0 : Document["administrative:expensePerDay/[" + expensePerDayInd + "]/expenseDietsTravel"]
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">curval</param>
                <param type="integer" name="value">expr:restaurant + customer + diets
                </param>
            </operation>
            <operation id="Context.SetVar">
                <param type="string" name="name">evaluation</param>
                <param type="boolean" name="value">expr:curval > threshold ?
                    true : false
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:needsmaximization</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:evaluation
                </param>
            </operation>
            <operation id="Document.SetProperty">
                <param type="string" name="xpath">administrative:message</param>
                <param type="boolean" name="save">false</param>
                <param type="serializable" name="value">expr:evaluation ? Document["administrative:message"] + "Los gastos de viaje diarios superan el límite en algún día. Puedes revisarlos para ajustarlos, o bien marcar que solicitas que se abone el importe máximo allá donde se supere. \n" :
                    Document["administrative:message"]
                </param>
            </operation>
        </chain>

    </extension>

</component>